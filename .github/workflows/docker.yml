name: Docker CI

on:
    - push

jobs:
    backend:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest]
                node: [lts/*]
                    
        steps:
            - uses: actions/checkout@v3
            - uses: docker/login-action@v2
              with:
                    registry: ghcr.io
                    username: ${{ github.repository_owner }}
                    password: ${{ secrets.GH_PAT }}
            - uses: docker/setup-buildx-action@v2
            - run: make -C backend app/build/distributions/app.tar
            - name: Docker meta
              id: meta
              uses: docker/metadata-action@v4
              with:
                images: |
                    ghcr.io/kruemmelspalter/filespider-backend
                tags: |
                    type=semver,pattern={{version}}
                    type=ref,event=branch
                    type=ref,event=tag
                    type=sha
                    type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
                    type=edge
            - uses: docker/build-push-action@v3
              with:
                context: backend
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
                cache-from: type=gha
                cache-to: type=gha,mode=max
                push: true
    frontend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: docker/login-action@v2
              with:
                    registry: ghcr.io
                    username: ${{ github.repository_owner }}
                    password: ${{ secrets.GH_PAT }}
            - uses: docker/setup-buildx-action@v2
            - name: Docker meta
              id: meta
              uses: docker/metadata-action@v4
              with:
                images: |
                    ghcr.io/kruemmelspalter/filespider-frontend
                tags: |
                    type=semver,pattern={{version}}
                    type=ref,event=branch
                    type=ref,event=tag
                    type=sha
                    type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
                    type=edge
            - uses: docker/build-push-action@v3
              with:
                context: frontend
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
                cache-from: type=gha
                cache-to: type=gha,mode=max
                push: true
